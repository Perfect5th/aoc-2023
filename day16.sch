;; The layout of the contraption.
;; . : no effect
;; \ : reflects N->W, E->S, S->E, W->N
;; / : reflects N->E, E->N, S->W, W->S
;; - : turns north or south into east and west
;; | : turns east or west into north and south
(define EXAMPLE
  '(".|...\\...."
    "|.-.\\....."
    ".....|-..."
    "........|."
    ".........."
    ".........\\"
    "..../.\\\\.."
    ".-.-/..|.."
    ".|....-|.\\"
    "..//.|...."))

;; list->hashtable : produces a hashtable mapping pairs of (x . y) coordinates to characters from
;; ls.
;; (list str) -> hashtable
(define list->hashtable
  (lambda (ls)
    (let ([ht (make-hashtable equal-hash equal?)])
      (let f ([l ls] [y 0])
        (if (null? l)
            ht
            (let g ([c (string->list (car l))] [x 0])
              (if (null? c)
                  (f (cdr l) (+ y 1))
                  (begin
                    (hashtable-set! ht (cons x y) (car c))
                    (g (cdr c) (+ x 1))))))))))

;; reflectors : A list of characters that reflect lasers.
(define reflectors '(#\\ #\/))

;; step : progresses loc in the direction of dir by 1.
;; (integer . integer) symbol -> (integer . integer)
(define step
  (lambda (loc dir)
    (let ([x (car loc)] [y (cdr loc)])
      (cond
       [(eq? dir 'N) `(,x . ,(- y 1))]
       [(eq? dir 'E) `(,(+ x 1) . ,y)]
       [(eq? dir 'S) `(,x . ,(+ y 1))]
       [(eq? dir 'W) `(,(- x 1) . ,y)]))))

;; reflect : produces a new location and direction from loc and dir according to the reflection
;; rules defined at teh top of the file.
;; (integer . integer) symbol char -> (values (integer . integer) symbol)
(define reflect
  (lambda (loc dir reflector)
    (let ([x (car loc)] [y (cdr loc)])
      (cond
       [(and (char=? reflector #\\) (eq? dir 'N)) (values `(,(- x 1) . ,y) 'W)]
       [(and (char=? reflector #\\) (eq? dir 'E)) (values `(,x . ,(+ y 1)) 'S)]
       [(and (char=? reflector #\\) (eq? dir 'S)) (values `(,(+ x 1) . ,y) 'E)]
       [(and (char=? reflector #\\) (eq? dir 'W)) (values `(,x . ,(- y 1)) 'N)]
       [(and (char=? reflector #\/) (eq? dir 'N)) (values `(,(+ x 1) . ,y) 'E)]
       [(and (char=? reflector #\/) (eq? dir 'E)) (values `(,x . ,(- y 1)) 'N)]
       [(and (char=? reflector #\/) (eq? dir 'S)) (values `(,(- x 1) . ,y) 'W)]
       [(and (char=? reflector #\/) (eq? dir 'W)) (values `(,x . ,(+ y 1)) 'S)]))))

;; follow-laser : traces the path of a laser from the location and direction pair start until all
;; its splits run off the map, adding up how many coordinates are touched. This follows the rules
;; commented above EXAMPLE.
;; (hashtable (x . y) -> char) -> integer
(define follow-laser
  (lambda (ht start)
    (let ([path (make-hashtable equal-hash equal?)])
      (let f ([loc (car start)] [acc 0] [dir (cdr start)])
        (let* ([visited (hashtable-ref path loc #f)]
               [acc-inc (if visited 0 1)])
          (if (eq? visited dir) ; Been here before, going this direction.
              acc
              (begin
                (hashtable-set! path loc dir)
                (let ([loc-char (hashtable-ref ht loc #f)]
                      [x (car loc)]
                      [y (cdr loc)])
                  (cond
                   [(not loc-char) acc] ; Off the map.
                   [(member loc-char reflectors)
                    (let-values ([(new-loc new-dir) (reflect loc dir loc-char)])
                      (f new-loc (+ acc acc-inc) new-dir))]
                   [(and (char=? loc-char #\-) (member dir '(N S)))
                    (+ (f `(,(- x 1) . ,y) 0 'W)
                       (f `(,(+ x 1) . ,y) 0 'E)
                       acc
                       acc-inc)]
                   [(and (char=? loc-char #\|) (member dir '(E W)))
                    (+ (f `(,x . ,(- y 1)) 0 'N)
                       (f `(,x . ,(+ y 1)) 0 'S)
                       acc
                       acc-inc)]
                   [else (f (step loc dir) (+ acc acc-inc) dir)])))))))))

;; solve1 : counts the number of tiles that get energized.
;; (list str) -> integer
(define solve1
  (lambda (input)
    (follow-laser (list->hashtable input) '((0 . 0) . E))))

;; possible-starts : produces a list of pairs of starting locations in ls and the directions to go.
;; These are based on edges and pointing towards the center. Corners can go two ways.
;; (list str) -> (list ((x . y) . symbol))
(define possible-starts
  (lambda (ls)
    (let ([max-x (- (string-length (car ls)) 1)]
          [max-y (- (length ls) 1)])
      (let f ([x 0] [y 0] [acc '()])
        (cond
         [(and (= x 0) (= y 0)) (f (+ x 1) y (append '(((0 . 0) . E) ((0 . 0) . S))))] ; top-left
         [(and (= x max-x) (= y max-y)) (append `(((,x . ,y) . W) ((,x . ,y) . N)) acc)] ; bottom right
         [(= x 0) (f max-x y (cons `((,x . ,y) . E) acc))] ; left edge
         [(= x max-x) (f 0 (+ y 1) (cons `((,x . ,y) . W) acc))] ; right edge
         [(= y 0) (f (+ x 1) y (cons `((,x . ,y) . S) acc))] ; top edge
         [(= y max-y) (f (+ x 1) y (cons `((,x . ,y) . N) acc))] ; bottom edge
         [else (f max-x y acc)]))))) ; non-edge, shouldn't happen

;; solve2 : finds the maximum possible energized tiles using different laser starting positions.
;; (list str) -> integer
(define solve2
  (lambda (input)
    (let ([ht (list->hashtable input)])
      (apply max 0 (map (lambda (loc-dir) (follow-laser ht loc-dir)) (possible-starts input))))))

(printf "~a~n" (solve1 EXAMPLE))
(printf "~a~n" (solve2 EXAMPLE))

(define INPUT
  '("\\..../.....-...|........\\.|...........-..........-......|....././..........\\..|..............................."
    ".../..|.......-............\\...........-\\|...............\\.....|......-...........................-./.......|."
    "......../.-.-....\\...\\-.......................................|..........-.......\\.....-.........|......|....."
    "....\\........./..............|.............-..|.|.\\.|.-......\\........./..................|..........\\........"
    "...|/.|..........................-........................|............|-..|...../\\................./.../....."
    "...|.|.......\\...................|/..........\\\\....|....................-..................|.................."
    "..................\\-|..........|.\\......|........\\.....\\...........................-..............\\.....\\....."
    "........./.-./..............................-..........|......|................/.............-......./...|./.."
    "....-...\\..........-......\\...............-/.....................\\.........-\\.........|..........|.....|......"
    "./............\\......./..-......................../.|.-.|........................./.|......|...\\.......-.-...."
    "...........././.............|..........-....../..............-.....\\.-......-.............................-..\\"
    "......................\\.|.\\..................-./.....\\....|......................|..\\...|....................."
    "...|.-...|.............../..//....-\\...-.-...........|......-....\\.|-.............\\....-.|.............\\......"
    "......|.....\\-....\\.............|../..|......\\....--................/....|..../|../.....-........../.........."
    ".............|.........-.../.|....................\\..........................................................."
    "....\\...\\.-..-.....|.|...........-........./..../..........-.-....|....-..............-....|........|....../.."
    "..........|..............\\..|........../..........................|.....|\\.-...........-......\\....../........"
    "...../.......|..../........-........|./\\..\\..\\.\\././.\\.............--.......-..................\\./......-....."
    "....................//...-..........-.............|................/............./.\\....../...........-......."
    ".\\-...|-/.......-........-...-...............\\../...........................\\/.....\\...........\\........|....."
    ".............................\\-......|......\\../......-..........|...........|.........-.....\\..|......-......"
    "./................/........-.......|..\\..../|............................|...........|.-.|...................."
    ".\\.....|...............-\\............|.................|...././.-...\\..........|...........-...|...-.....\\...."
    ".......-..../.........\\|.....................|....../..|/./|..........|.......|-.......\\\\./......-............"
    ".....................\\|......../-.............\\...|...........................\\.....\\.\\......................."
    "...|\\.././...................|..................-.../\\.-............\\.-.........../............../.....\\......"
    ".......\\..................\\..|../...........................\\....\\....\\..../...\\..\\\\./.-....................|."
    "...............|./...\\..........|...|....\\........./......\\...\\.............\\.\\-......|......-...-........|..|"
    ".........-...........................-...-............\\...\\.\\.................................-....|./........"
    ".-.|............-.....................-.................\\..../......\\....\\....\\....................|.......-.."
    ".....\\.|......|..../................|......|.....-...\\|../................./...................//............."
    ".|.........\\..../......-........-............--...................../........|.......\\.....\\..........-......."
    "../.....|.|............-.................|\\.....|....||...-..-....|/......................|.|-..-..........||."
    "...-............|.-.............-.....................\\.|.............\\.\\............\\...|........|...../.\\..."
    "\\...........................\\.|................................................/.|......-.......\\........../.."
    "...................|....|.......|.-.............-..-\\...-...............................|..................../"
    "/...../.....\\............../...........|..|./...-.../...............................\\........../|.........\\..."
    "..-.......|.........../.......|......../.......\\.............../..........-|.................................."
    "...\\.\\........\\............|......................\\........|...\\.............................................."
    "../..........--........|....-..............\\..\\.............\\...................-........./...../..-.........."
    "..................|.................../\\..-..|..................\\....././..|......-.................../......."
    "-...\\.............\\..-..-.................../...|.|.........|../|./............/...../............../........."
    ".|\\............................-....................|......./..............................|..-|...|.\\........"
    "-........../...-....-.......................|...\\........|.......\\................../........................."
    "........................................................././.|..|.........\\................/|........\\........"
    "-.....\\.........................|...........|..||..|......................................\\...\\....../.......|"
    "....\\...|........\\.........................//...........|........-.........\\..........\\-.....\\................"
    "....|........|.........../........../....\\........|......-../..............|...............|.........../......"
    "......\\................-...........|.................\\...../........|................-........................"
    "...............|......|...\\............\\............/.../.......-.-../............................\\......|...."
    "............-........-..../.......................\\..-./.....\\...................................-\\.....|....."
    "...|...../......\\...........\\......\\...\\......./...........-../..|......................../...|..............."
    "...........................-...../....-.....//................../..........-.......|.................|..-....."
    "................-...\\.............\\.../.../.\\../...|.........-.\\...../.................\\.............../\\...\\."
    ".....-..................../......................................-...-............/...........|...-..........|"
    ".........-..........\\.\\................-..\\............................|...................-........./........"
    "...............-....../.....\\...|.........\\.../\\.......-......|............\\-.................|...-..........\\"
    ".....\\/......../../|......\\......|.....--............|....../........-.../....-...-..........................."
    "..../....\\....|.............../..|........./............-.........................................../........."
    ".........../.................|....-..........................................................................\\"
    "...-.....-./....................\\..../.\\\\.................-.....-....|..\\.....-....|.........................."
    ".....-..\\..........|....|...........|.|....................................\\.......-.../.../-.-........-.../.."
    "............../......./...-.......-..|.......-|..........\\..............-.-....|..............\\..............."
    "-........../.........|.......................\\....-........../.........\\.................../.............-...."
    ".......-....\\.....\\..................\\..../-.//.....-\\..........|........................../....|.....\\......."
    "..-./............./|..|........|...\\\\.........\\...|......|.....\\.........../.\\......................\\........\\"
    "...../|.......\\............../....................|.............-...........|......|....../.........../....-.."
    ".............-...-...|..\\-.........................................|.......-.........|.........\\.............."
    "......|......|............/.........................|.............\\.............../....................|..-..."
    "../../|\\......|..//....../......................................................./-...................../....."
    ".....-........-................-.............|.-./..............|...-...../......................../..../....."
    "...........\\......|.............|....|.|.........../........|....................\\.\\......./..\\.\\..|.........."
    ".\\................/....................-..............................|...........\\....\\.......-....../.../..."
    "...............|................-.....................................-..................\\...............\\...."
    "..........|\\..................../............................./...............-.....-....-..|................\\"
    ".................\\.\\...........................................-../......\\.....-...............|...\\.........."
    "..|....\\............................................./.........|...-\\.........-...\\..|..........\\............."
    "..................................|...........-....-./-.\\.-..................-............................./.."
    "....................................\\-.....\\\\...../..................-............-........../........-....\\.."
    "...........\\......./...../|\\..../-....|........|.|-.....-....|.....||.....|...........\\..........\\....|.-....."
    "...\\..........\\./..............-........................././..........\\././...-...........-............-...../"
    "\\........\\.....-..............................\\................../.............-........................\\..\\.."
    ".........../.\\...............-.\\...-.....\\............\\....\\......--.....\\...................................\\"
    "............\\...............\\.........\\\\....\\....|......\\.......-.................|...|....\\.....\\...\\........"
    ".....|.....-............../............-............../.............../...................-......\\...........-"
    "..........................-...|......\\.....\\.......\\........-................./..........-......../.../...-/.."
    "../........|....\\........|..../...........|...-..|..........\\............\\..../........-................|.\\..."
    "..........-............./........................................-.......\\.|/......./.................\\.../.-."
    "......................\\.........................../.../...../../.......|...................|............|....."
    "..............\\..........-/........|/................................\\...........................-............"
    "........\\....\\....../.......|.-........\\........-..\\.................................|.....\\-................."
    "........\\......|.\\.................-..-.../.............\\..................|.../.-.............-/............."
    ".|/.............-.\\.........................|...|./........-...........\\../...............\\./.......-......\\.."
    "..................-....|.....................-........|/.................\\.........../..-.............../..\\.."
    "......-......-.........../......................-......./...../.../.|........\\.../....../............\\.....|.."
    "...|../..................-.................\\.....................\\............-...........|.....|.|.........-|"
    "..............................-...........|..-/.................|................................../.........."
    ".../......../.............-./.............|...../......./...|...........\\..............-..........-....|..-./."
    "/..\\...|...........|...........................|/................../......./......................\\.....\\....."
    "..|.........-........|..|......-...................\\.........|...........................-...................."
    "../...-.....-.............../...|\\...\\.......|.................|.\\.........-...................-\\.........-./."
    "../..............................|.......|..............\\...\\......................\\..........|..............."
    "............/....|../....../.............-............................./......./.................\\............"
    "/.....\\...../.........../.............../...-.../\\.....|.....|............|....|..........\\.....\\..../........"
    "....\\....-/.........................|............-...........\\........\\...\\.....\\\\................\\........-/."
    ".....................-..-\\...............././...........................\\....-./......|..............\\..-....."
    "................./........|.......-.-....................\\.-.||...-.......\\./.|./.....|...-.../......./......."
    "........-..-...../.......\\.........................\\.....././.\\.../..|...../.................................."
    ".............|...............--.........../.|\\/.....\\.........................|..|.....................-......"
    "..........-...|.......\\/...................|....../.-...-...|....................\\..../.-...../..../..-......."))

(printf "~a~n" (solve1 INPUT))
(printf "~a~n" (solve2 INPUT))
