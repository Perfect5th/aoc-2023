(import (grid-utils))

;; A map of starting position (S), garden plots (.) and rocks (#).
(define EXAMPLE
  '("..........."
    ".....###.#."
    ".###.##..#."
    "..#.#...#.."
    "....#.#...."
    ".##..S####."
    ".##..#...#."
    ".......##.."
    ".##.#.####."
    ".##..##.##."
    "..........."))

;; dfs : a memoized recursive depth-first "search" through grid, starting at #\S. Terminates after n
;; steps, adding the final location to the returned hashtable.
;; (vector (vector char)) -> (hashtable (pair number number) -> #t)
(define dfs
  (lambda (grid n)
    (let ([start (grid-find grid #\S)]
          [terminals (make-hashtable equal-hash equal?)]
          [memo (make-hashtable equal-hash equal?)])
      (let f ([loc start] [steps 0])
        (cond
         [(hashtable-ref memo (cons loc steps) #f) '()]
         [(char=? (grid-ref grid loc #\#) #\#) '()]
         [(= steps n) (hashtable-set! terminals loc #t)]
         [else
          (begin
            (hashtable-set! memo (cons loc steps) #t)
            (for-each (lambda (l)
                        (f l (+ steps 1)))
                      (cardinals loc)))]))
      terminals)))

;; solve1 : Counts the unique sets of coordinates that can be reached in n steps across the input.
;; (list string) number -> number
(define solve1
  (lambda (input n)
    (vector-length (hashtable-keys (dfs (string-list->grid input) n)))))

(printf "~a~n" (solve1 EXAMPLE 6))

(define INPUT
  '("..................................................................................................................................."
    ".....................#..#.#.#..##..........#.#..#...#.......#...............##..#.....#.......#......#.#..........#..#.......##.#.."
    "....##........#..#.......#......#.....#..............#...##.............#..............#...........#.......#.#....#..#....#..#.##.."
    "......#..........#..#.#......##................#.#.......#..................###.....##.......#.....#..#.#..........#.......##.#..#."
    ".#....#.....#......##.........#..........#..##.....#.........................#.....##.#...#....###..##.#..........#.#..#.##........"
    "....#..............##..#.......#..............#.....#.......................#.#..##...#.####........#.....#.#.....#...#.....#...#.."
    "........#...#.#....#........##.........#............##..........#......................#...#.....#...#...#....#....#..#..#..#......"
    "..#..#..#..#.....##.....#.....#..#.#.....#.#.#..#.............#.#.#..............#..#...........#..##..#.....#....#................"
    ".......................#.#..#.#.#....#...##.......#..#........#...#................#.###....###..............##....##...#.........."
    "...##.....#..............#.#...........#.........#.#.........#.....#................#.....#..#.....#................#....#.......#."
    "...#..........#.........#...........#....#.......#...........#.......................#.........#...........#........##............."
    "...........................#..#.##.....#.#......#.................#....#........#.###.......##.....#.#..#...#..##.#...#.#....#.#..."
    "......#..#.#....#.##.#...#..#..#.#.............#.....................#...............#.....#.#...........#......#.................."
    "...#..#..........#.......#..#.....................................................#......##...#..#.#........#.##.#..#.##..........."
    "...#.#....###.#..............#.#.##.......................#............#...#........#.....#...##...#........#.#...#..............#."
    "...#............#....#......#.....#....#................#....#.#...#.#....#.........#........#.....#.....#.#..#..#.#.........#....."
    ".#..#.......#......#.#..#...#.#........#...............##............#......##.......#...#.#.#..#.#............#....#.......#..#..."
    ".....##..#..#.............#.........#...#.#..........#......#........#.#..##............................##.....#..#....#..#......#."
    ".#.....#...##........#.........#..........#..........#..#...#...#.#........#............#.........#......#....#...................."
    "..#........#.....#..#...#.#..##.....#..#...........##.....#..#..#.##..#..#......................#.#..#....#...#..##........#.##.##."
    "...............#..##............##.................##.........###......#..#.#..............###..........##..##..#........#........."
    ".......#.....#.............#....................#.......##.............##...#...........................#..#......##.##..#....#...."
    ".###.....#......###.............#......#................#..#.#..#......#..#............................#.##....#.....#....#....#.#."
    "..##.#.........#........#.....#.#....#........##........##..........#..#...#..#....#..........##.........#..........#...##........."
    "..#.#.##.#...#....#..#.#.#......#...............#.#.#.#...#....#..#..##..#..#..#..#.#..............#.##.............#.#...#...##..."
    "..#.#..#...........#......#.........................#....##..#..........................................#.................#........"
    ".........#..#..................####............#.#..................#........##..................##.#..#..##.#..#.#.....#...#.#...."
    "............#.##......#.......#...#.......#.....#........#...#..#...#.#...........#...#.#..........#..................#...#.#.#...."
    "....#.........#...#.##....#.#...#..........#.........#..#......#...#...............#...#...............................#...#......."
    ".#....#.....#.........#..............................#....##.#.....#........#...#.......#...............#......#.....#....##.###..."
    "................#............#.#.............#...........#..#.....#.##.....#.#.........#..............#..#....#...................."
    "....#..................##................#......#............#.......#...............................##.#......#...##...........#.."
    "...#..#..#.........##.#..............#.........##.#......#...........#.....#....#....#......#..............#......#..#........#.#.."
    ".......#...#...#..#.....#...#...........#...........#......#...#.....#....#.....#..........#...............#.#.....#...#.....##...."
    "....#....#........#..#...................#...#.###...........#.##.#......#....#.#..##...#...##.............#......#..#..#.......#.."
    "....#.#....#......##..................#...................#.##.#.........................#................#......#.#.#....#........"
    ".#......#..###...........#.............#........#......#.....#....#........#..................#.##........#...#....##...#..#......."
    "...................................#.........#................#..........#.......##..#..##...#...#.........#......##........#.#...."
    "...#..#.........#............................#....#.....#....##..............#.........#...................#..#...#...#.....#..#.#."
    "...##..........#................###........##...#.....#...###.......#....#.........#.........#...#....................#......##...."
    ".#.......####..#...#...........#..##..#..#.......#....##..#...##...#...#...#......#...#...#...#..#...#.........#.#..###...#...####."
    ".###........................#...............#..........#..#.#..#.......##..#.#.#.#.#....#..........#......................#.#......"
    "......#...#....................#...##.....#..#........#................##..#....#.........#...#.......................#....##......"
    "...#........#.................#...........#.#.....#....#...........#....#.......#....#..#.#.#.....#.............#.#.....#.....#.#.."
    ".......##...##...#...........#.#.......#........#......##............#.......#....#.............#.#.#......................#......."
    "..####.....##................#.#.##............#.....#..........#........#....#..#.........#......#...#..##.........#...........#.."
    ".#.#.#........#.........#.............#..............#...#....#.#....#..#....#..#....#.#.#.#..#..##......###..........##..#........"
    "....#...#...#.#........##..#............#........##..#.............#..#....#..####..#..........#....#.............................."
    ".....#......#................#...#..#...........#...##......#..............###........#....#.....#..........#......................"
    "...#.................#.....##....#......#........#.#....#.........#..#.....#...................#.........#......................#.."
    "....##..#.#.............#....#....#.......#..#......#..............#..............#......#..#.............#...#...........#...#...."
    "..................#..........#.......##...##.#..#...#...........#....#.#......#.......###...#.##..........#...................#.#.."
    ".................#...#....###.#..#...#.............#..#.#.............#...........#.#......##..#.#...##..##.#.#...........#.#......"
    "....##..................#......#.#..##..#......#...............#.......#....#.........##...###..#..#..#......#..#.............#...."
    ".....##.............##..........#................#........#...#.#..#.#...#..#..#....#.#............#...#..#.................#......"
    "...............#..##.#.#...........##.#..........#.#.....##.##..#.......#.#...........##.......#.##.#.#....#.....##................"
    "..#............#.........#.....#.#..................#..........#....#.......###...#.#...............#..##.....##.#................."
    "...............#..##..#.......#..#.......#..#.#.........#..#..........#..#..##..........#........................##...........##..."
    "...........#.#.........#.#...........#.....#...................#...##.###...#.......#...#...#...##.....#....#...#.#................"
    "............#....##......................#...#...........#......#..#......##.......#...........#....#.#..........#.....##.......##."
    ".#.......##........#............#...................#.#....#.#.......#...#........#....#..#..#...#....#............#...#..........."
    "...................##..##......#.................#.#...........#.....#.#........#....#......#.................#..##....#..........."
    "...........#......#.#.........#..#..#.......#.......##....................#.......##...##....#....#.....#.........................."
    ".........#.#.#...#....##..#....##....##...........#....#...#..............#...#..###.#..#.................#..#...#.......##........"
    ".............###...#.............#.....................................#...#......#......#............#.#.......#............#....."
    ".................................................................S................................................................."
    ".....#.#........#.............##.##.......#..#..##.....#............#....#..#.#.#.......#.#.................#..........#.....#....."
    ".........##.#............#..#........#.............#..#..#..#.##..#..#..........#..................#........#......#........#......"
    ".......#..#..................#....#...#...#............##......#....#...#..............#..#...#........#....##...........#........."
    ".........##.....###............#..........##..##.........#.....##.........................#..............#.........##.#............"
    ".............###.#....####...#..#....#......#.#..#.#.#.#......#.........#................#........#...#.#..........#..#............"
    ".............#.#..#....#...............#.....#.#....#..#.....#.........#...#......#......#.#........#.##.#...#....................."
    "...........#....#.#........##....#...#.......#..........##..........#............#....#......#.#..........#.#..................#..."
    "..............###......##....#.#......#..#....#...........#........#.#...#.....#.......#..#..#........#.........#....#............."
    ".#............#..#....##.#.....#..#..#.##....##.#....##.............#....###.....#......#.#...................#.##................."
    "...####.......................#.##.#...#.#......#..##.#.....#.......#....#....#...#.........#....#.#...........#..................."
    "..#...##.......#...#.......##.#..#.....#.........#......#.#...#...........#..........#..........##.#......##.#...................#."
    ".#.#............#..#..#..#.#....#.....................#...........#.###.#........#...#...........#.........................#......."
    "..#...............#.#.##........#.#..#.##.#.#....##.##..#....#.....#................#.....#..#....#.........#...#.............##.#."
    "........#.#.......#...#......#........##.#.#.....##......#...............#.#...#..........................#..............#...#....."
    "...........#........#.......#......#..#..#....#.#.....#..##..#.#......#............#..........................#.................#.."
    ".##.#....#............#........#......###...##....#####.#..#...........#...........#...........#......#..#....#............#.#..#.."
    "......................#...........#....#.......#.#................#.#.#.........#.#.....#....................#........#..#.#..#.#.."
    ".##........#...........#....#.........#..####..#............#.#.#...#.#..#.......#.....#..#.................#..........#....#..###."
    "....#.##.#..............#.#.........##......#........##............#.........##...#....#.#.......#.........................#....#.."
    "......#.....##...............#............#..##........#...........#.##....................#........##..#.............#......#...#."
    "............................#..............#...#.......##....#....#..........##....#...#....#..##..#.#.............##...##...#....."
    ".#....#.....#....#...............#......#..#.#.#....#..#.##..............#.#.......#...............##...........#...........#...#.."
    ".#...............#..........##....#..........#.....#.#...#..#.###.#...##........#......#.##.......#............#...#.#.#..#........"
    ".......###...#................#.#......##.........#...##..##....#...#....###..........##.#.##.....................#.#...........#.."
    "..##...#..##.#..#....#..........#.................#...#.........#.##.......#...##......#.#..#.....#..............#...#............."
    ".#.#....#.....#....#..................#.#...........#.............#..#......#...#........#..##..#.........................#.....#.."
    "........#..##....#.................#......#.#...#..#......#.#............................#..#....#................#.........#....#."
    ".#......#...#......#.#..#.......#.#.....#..#...#......#.#..#.#.....#.#.................#...#..#.....................#....#........."
    "......#....#........#.###............##....#....##..#..............##..##.............#.........#...........#.#..#....#.#...#.#...."
    "..#........#...................................#..###........#.#....#.#.#......#.#.............................#..##..#.......#...."
    ".......#.#.#...#..........#........#.......#..##.......###.#..##....#............#.#...#...#............#...#................#..#.."
    "....#...........#.#..#....###.........#...#.......#...#...................#....#.#.#..###....#...........................#.#.#.#..."
    "....#....##.##.#.#.....#...#...................#.#.............#.............#...#..#.....#............#.......................#..."
    ".........#..#..#....#....#................#..........#..................................#............#..##..........#.#......#....."
    "....#.#.#...#......##.....#...............##..........#.......##...#...#.##.....##.....#..#............##..............#....#.#...."
    "..#......#.#......##........#...........#.#.#..#.........#.#..#.........#...#..........#..............##..#...#....#......#..#....."
    ".###..........#.#.....#..#.......#............#..#..............#...#..##.#.......#...............#.......#.................###..#."
    ".#......#..#.##......##.#..#.#.............#..#..#...###...#...#...#...........#....#.................##....#...........#..###....."
    ".#.........#...........#........#.#........#.#.#....#........#.....###....#.#..#.##.................##...#.........#..#......#....."
    "..#.#.........#........#.#.#..#.#...............##.#............#.....#.#............#.........#.#.............#.#.#.#...........#."
    ".....#.#................#.....#.#..#..................................#.#.#..#..#..#....................#.....#........#..........."
    ".....#.#.........#.......#...#..#......................##.........#.#.##....##.....#........#...##.#..#..#...#.#....#..........###."
    "...#...........#.......#.#....#.......#...........#.....#....#..#..#....#..#..................#.#.........#.###...#....#....##.#..."
    "....##....#.#......##....#...#....#..#................#..#..#...#.#....#.............................#.........#........#.#..##..#."
    ".#................#......#....##.#..###..#.......#...#.........##.#...##......#.#........#.#.......#......#........#.#...........#."
    "....#...........###.................#....##.......#..#.....#...#....#.........#................#..#....#...#...#....#...#.....#..#."
    "...#....#..#.........##.#.....#......##.............##............#..#........#.............##.##....#.....#.....#...#.....#......."
    "...#.#...#.#.#..#..............#..##..#.....#.......#..........#.....#.#..............................#............................"
    "...#.....#.......#..#.......#....##.##..................#.##.............#.......................##..#.....#...#........#......#.#."
    ".....##.....#...........##.#.##.....#..###..................###......#..#..............#.#.#...#......#...###..........#.#..#..#.#."
    "...#.......#.......#.....##.................................#........##.#.............#...#............#.....##....#.....##...#...."
    ".#.##............#.#..............#.....#...#..#...................#.#..............#....#....#.#.#.....##..#.#...#...#.#....##.##."
    "...........#....#....#.....##..........#.#.....##............#........#..#............#....##..#.#...#...##............##...#......"
    "..........#.....##...............##......#......###..........##........#....................##......#...#........#...............#."
    "..#.......#.....#....#..............#.....#...#...............#.................##....#........#......##.#..........#.##....#..#.#."
    "...#..##..#.........#......#......#..##.#.........#...................#.......#............#........#......#.......#........#......"
    "..................#.#.#.#...#.......#..##.#..#.#................#.#..............#.#...................#...#...#........#........#."
    "....#.#.#......#.....#...#.........#..#....#..#.#...#...............#.......#...#.............#.#.#.#.....#......#...#.#..#....##.."
    ".....##.......#...#...........#.#.#.#....#.##...##.....#...................#...........#....#.#..#...#......##...........#..#...#.."
    ".............#.#........#........#...##......#.....#.#.......................###..#.........##...........#.....##..##.....#.###...."
    "......###..#.........#.#......#.........#.....#....#..#.#.................#.......#.........#....#.......#...###...#.............#."
    "..........##....#.#....#...#.......#.#....#.#...#.......#...............#.#..#............#..#...#.#....#..........#..#......#...#."
    ".#.......##..#.##....#.........#.....#.#.........##.................................#.....#....#.#.#..##.#....#..........#.#...#..."
    "...........#.......#.#.#.#........#..........#.#..#.#..##.................#..#.................#.#....#...#......#.............#..."
    "..................................................................................................................................."))

(printf "~a~n" (solve1 INPUT 64))
